{"ast":null,"code":"import { getSession } from \"next-auth/client\";\nimport { connectToDataBase } from \"../../../utils/db-utils\";\nimport { hashPassword, verifyPassword } from \"../../../utils/auth-utils\";\n\nconst handler = async (req, res) => {\n  if (req.method !== \"PATCH\") {\n    return;\n  }\n\n  const session = await getSession({\n    req: req\n  });\n\n  if (!session) {\n    res.status(401).json({\n      message: \"Not Authenticated!\"\n    });\n    return;\n  }\n\n  const userEmail = session.user.email;\n  const oldPassword = req.body.oldPassword;\n  const newPassword = req.body.newPassword;\n  const client = await connectToDataBase();\n  const usersCollection = client.db().collection(\"users\");\n  const user = await usersCollection.findOne({\n    email: userEmail\n  });\n\n  if (!user) {\n    res.status(404).json({\n      message: \"User not found\"\n    });\n    client.cllose();\n    return;\n  }\n\n  const currentPassword = user.password;\n  const isValidPassword = await verifyPassword(oldPassword, currentPassword);\n\n  if (!isValidPassword) {\n    res.status(403).json({\n      message: \"Invalid Password\"\n    });\n    client.close();\n    return;\n  }\n\n  const newHashedPassword = await hashPassword(newPassword);\n  const result = await usersCollection.updateOne({\n    email: userEmail\n  }, {\n    $set: {\n      password: newHashedPassword\n    }\n  });\n  client.close();\n  res.status(200).json({\n    message: \"Password Updated\"\n  });\n};\n\nexport default handler;","map":{"version":3,"sources":["/home/kedar/Documents/my projects/web/Next Js/nextjs-auth/pages/api/user/change-password.js"],"names":["getSession","connectToDataBase","hashPassword","verifyPassword","handler","req","res","method","session","status","json","message","userEmail","user","email","oldPassword","body","newPassword","client","usersCollection","db","collection","findOne","cllose","currentPassword","password","isValidPassword","close","newHashedPassword","result","updateOne","$set"],"mappings":"AAAA,SAASA,UAAT,QAA2B,kBAA3B;AACA,SAASC,iBAAT,QAAkC,yBAAlC;AACA,SAASC,YAAT,EAAuBC,cAAvB,QAA6C,2BAA7C;;AAEA,MAAMC,OAAO,GAAG,OAAOC,GAAP,EAAYC,GAAZ,KAAoB;AAClC,MAAID,GAAG,CAACE,MAAJ,KAAe,OAAnB,EAA4B;AAC1B;AACD;;AAED,QAAMC,OAAO,GAAG,MAAMR,UAAU,CAAC;AAAEK,IAAAA,GAAG,EAAEA;AAAP,GAAD,CAAhC;;AAEA,MAAI,CAACG,OAAL,EAAc;AACZF,IAAAA,GAAG,CAACG,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB;AAAEC,MAAAA,OAAO,EAAE;AAAX,KAArB;AACA;AACD;;AAED,QAAMC,SAAS,GAAGJ,OAAO,CAACK,IAAR,CAAaC,KAA/B;AACA,QAAMC,WAAW,GAAGV,GAAG,CAACW,IAAJ,CAASD,WAA7B;AACA,QAAME,WAAW,GAAGZ,GAAG,CAACW,IAAJ,CAASC,WAA7B;AAEA,QAAMC,MAAM,GAAG,MAAMjB,iBAAiB,EAAtC;AACA,QAAMkB,eAAe,GAAGD,MAAM,CAACE,EAAP,GAAYC,UAAZ,CAAuB,OAAvB,CAAxB;AAEA,QAAMR,IAAI,GAAG,MAAMM,eAAe,CAACG,OAAhB,CAAwB;AAAER,IAAAA,KAAK,EAAEF;AAAT,GAAxB,CAAnB;;AAEA,MAAI,CAACC,IAAL,EAAW;AACTP,IAAAA,GAAG,CAACG,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB;AAAEC,MAAAA,OAAO,EAAE;AAAX,KAArB;AACAO,IAAAA,MAAM,CAACK,MAAP;AACA;AACD;;AAED,QAAMC,eAAe,GAAGX,IAAI,CAACY,QAA7B;AACA,QAAMC,eAAe,GAAG,MAAMvB,cAAc,CAACY,WAAD,EAAcS,eAAd,CAA5C;;AAEA,MAAI,CAACE,eAAL,EAAsB;AACpBpB,IAAAA,GAAG,CAACG,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB;AAAEC,MAAAA,OAAO,EAAE;AAAX,KAArB;AACAO,IAAAA,MAAM,CAACS,KAAP;AACA;AACD;;AAED,QAAMC,iBAAiB,GAAG,MAAM1B,YAAY,CAACe,WAAD,CAA5C;AACA,QAAMY,MAAM,GAAG,MAAMV,eAAe,CAACW,SAAhB,CACnB;AAAEhB,IAAAA,KAAK,EAAEF;AAAT,GADmB,EAEnB;AAAEmB,IAAAA,IAAI,EAAE;AAAEN,MAAAA,QAAQ,EAAEG;AAAZ;AAAR,GAFmB,CAArB;AAKAV,EAAAA,MAAM,CAACS,KAAP;AACArB,EAAAA,GAAG,CAACG,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB;AAAEC,IAAAA,OAAO,EAAE;AAAX,GAArB;AACD,CA5CD;;AA6CA,eAAeP,OAAf","sourcesContent":["import { getSession } from \"next-auth/client\";\nimport { connectToDataBase } from \"../../../utils/db-utils\";\nimport { hashPassword, verifyPassword } from \"../../../utils/auth-utils\";\n\nconst handler = async (req, res) => {\n  if (req.method !== \"PATCH\") {\n    return;\n  }\n\n  const session = await getSession({ req: req });\n\n  if (!session) {\n    res.status(401).json({ message: \"Not Authenticated!\" });\n    return;\n  }\n\n  const userEmail = session.user.email;\n  const oldPassword = req.body.oldPassword;\n  const newPassword = req.body.newPassword;\n\n  const client = await connectToDataBase();\n  const usersCollection = client.db().collection(\"users\");\n\n  const user = await usersCollection.findOne({ email: userEmail });\n\n  if (!user) {\n    res.status(404).json({ message: \"User not found\" });\n    client.cllose();\n    return;\n  }\n\n  const currentPassword = user.password;\n  const isValidPassword = await verifyPassword(oldPassword, currentPassword);\n\n  if (!isValidPassword) {\n    res.status(403).json({ message: \"Invalid Password\" });\n    client.close();\n    return;\n  }\n\n  const newHashedPassword = await hashPassword(newPassword);\n  const result = await usersCollection.updateOne(\n    { email: userEmail },\n    { $set: { password: newHashedPassword } }\n  );\n\n  client.close();\n  res.status(200).json({ message: \"Password Updated\" });\n};\nexport default handler;\n"]},"metadata":{},"sourceType":"module"}